---
layout:     post
title:      线程同步
subtitle:   线程系列
date:       2017-03-29
author:     wan7451
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - Thread
    - Java
    - Android
    - Thread
    - ThreadPool
---
# 线程同步
在Android开发中，为了避免阻塞主线程，提高程序的运行效率，一般都会创建多个线程。但在多个线程同时运行时，有可能会调用到同一个方法或变量，由于CPU时间调度上的问题，写入数据会被多次的覆盖，出现不可预知的结果。为了避免这种问题，就要使线程同步。

如果你的代码所在的进程中有多个线程在同时运行，而这些线程可能会同时运行这段代码。如果每次运行结果和单线程运行的结果是一样的，而且其他的变量的值也和预期的是一样的，就是线程安全的。如果多个线程先后更改数据造成所得到的数据不是预期数据，则是线程不安全。

```
class TestRun implements Runnable {
    private int p;
    @Override
    public void run() {
        p++;
        System.out.println(p + "");
    }
}
```

```
TestRun run=new TestRun();
for (int i = 0; i < 5; i++) {
    Thread t=new Thread(run);
    t.start();
}
```

这段代码，我们期望的结果应该是 1 2 3 4 5 ，但是实际的结果却是 1 3 2 5 4。 这种情况便是线程不安全。

这是由什么原因造成的?要从Java内存模型说起。


### Java内存模型

JAVA 内存模型描述线程之间如何通过内存(memory)来进行交互。 具体说来， JVM中存在一个主存区（Main Memory或Java Heap Memory），对于所有线程进行共享，而每个线程又有自己的工作内存（Working Memory），工作内存中保存的是主存中某些变量的拷贝，线程对所有变量的操作并非发生在主存区，而是发生在工作内存中，而线程之间是不能直接相互访问，变量在程序中的传递，是依赖主存来完成的。

Java内存模型的抽象示意图如下：
![](https://github.com/Wan7451/wan7451.github.io/blob/master/_posts/images/thread-memory.png?raw=true)

从上图来看，线程A与线程B之间如要通信的话，必须要经历下面2个步骤：

1. 线程A把本地内存A中更新过的共享变量刷新到主内存中去。
2. 线程B到主内存中去读取线程A之前已更新过的共享变量。

下面通过示意图来说明这两个步骤：
![](https://github.com/Wan7451/wan7451.github.io/blob/master/_posts/images/thread-memory2.png?raw=true)

本地内存A和B有主内存中共享变量x的副本。

1. 假设初始时，这三个内存中的x值都为0。
2. 线程A在执行时，把更新后的x值（假设值为1）临时存放在自己的本地内存A中。
3. 当线程A和线程B需要通信时，线程A首先会把自己本地内存中修改后的x值刷新到主内存中，此时主内存中的x值变为了1。
4. 随后，线程B到主内存中去读取线程A更新后的x值，此时线程B的本地内存的x值也变为了1。

### 内存可见性

如果线程A对共享变量X进行了修改，但是线程A没有及时把更新后的值刷入到主内存中，而此时线程B从主内存读取共享变量X的值，所以X的值是原始值，那么我们就说对于线程B来讲，共享变量X的更改对线程B是不可见的。
![](https://github.com/Wan7451/wan7451.github.io/blob/master/_posts/images/thread-memory3.png?raw=true)







线程同步，就是用来解决线程不安全的问题。

![](https://github.com/Wan7451/wan7451.github.io/blob/master/_posts/images/thread-status.png?raw=true)

可以使用以下方式进行代码同步

1. 同步方法
2. 同步代码块
3. 使用特殊域变量(volatile)
4. 使用重入锁
5. 使用局部变量
6. 阻塞队列
7. 使用原子变量

> http://www.cnblogs.com/XHJT/p/3897440.html
> http://blog.csdn.net/beiyetengqing/article/details/49583381

